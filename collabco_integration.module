<?php
/**
 * @file
 * Code for the Collabco Integration module.
 */

include_once 'collabco_integration.inc';

/**
 * Implements hook_init().
 * 
 * We set an integration context early on if we are on an integration page 
 * provided by a feature. We also set the context value to the content type.
 */
function collabco_integration_init() { 
  // Check if the current path starts with node or user.
  if (((arg(0) === 'node') || (arg(0) === 'user')) && is_numeric(arg(1))) {

    // Find all Collabco integrations.
    $integrations = module_invoke_all('collabco_integration');
    foreach($integrations as $integration) {
      if (empty($integration['entity']['node'])) {
        continue;
      }
      foreach($integration['entity']['node'] as $bundle => $options) {
        if (!empty($options['tab'])) {
          foreach($options['tab'] as $label => $tab_options) {
            //Check if the integration subpath matches the current subpath.
            if (arg(2) === $tab_options['subpath']) {
              context_set('context', 'integration', $bundle);
            }
          }
        }
      }
    }
  }
}

/**
 * Implements hook_views_pre_view().
 * 
 * Add "Add content" links to integration views.
 */
function collabco_integration_views_pre_view($view, $display_id, $args) {
  //Find all Collabco integrations.
  $integrations = module_invoke_all('collabco_integration');
  foreach ($integrations as $integration) { 
    if (!empty($integration['views'][$view->name][$display_id]['add_content_link'])) {
      if (empty($integration['entity']['node'])) {
        continue;
      }
      foreach($integration['entity']['node'] as $bundle => $options) {
        if (!empty($options['add_content_link'])) {
          $bundles[$bundle] = $bundle;
        }
        $areas = $integration['views'][$view->name][$display_id]['add_content_link']['areas'];
        collabco_integration_views_content_link($view, $display_id, $bundles, $areas);
      }
    }
  }
}

/**
 * Implements hook_collabco_integration().
 */
function collabco_integration_collabco_integration() {
  // Add links to views if a module wants to do that.
  return array(
    'collabco_integration' => array(
      'entity' => array(
        'node'=> array(
          'basic_page' => array(
            'add_content_link' => TRUE,
          ),
        ),
      ),
    ),
  );
}
